"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1226],{8155:(e,t,l)=>{l.d(t,{c:()=>n});var i=l(95155);l(12115);var a=l(72478);let n=e=>{let{diagnoses:t}=e,l=[{field:"condition",headerName:"Diagnosis",flex:1},{field:"label",headerName:"Diagnosis Type ",flex:1,renderCell:()=>(0,i.jsx)("span",{children:"Differential Diagnosis"})},{field:"obsDatetime",headerName:"Date Recorded",flex:1,renderCell:e=>{let t=e.row.obsDatetime;return(0,i.jsx)("span",{children:t?new Date(t).toLocaleDateString():"N/A"})}}];return(0,i.jsx)(a.WE,{rows:t,columns:l,height:"400px",width:"100%",showTopBar:!1})}},13372:(e,t,l)=>{l.d(t,{J:()=>j});var i=l(95155),a=l(72478),n=l(90702),s=l(263),r=l(25641),o=l(87295),d=l(66637),c=l(95582),u=l(12115),m=l(33115),f=l(35068);let b=()=>[{value:s.W.POSITIVE,label:"Positive"},{value:s.W.NEGATIVE,label:"Negative"},{value:s.W.INDETERMINATE,label:"Indeterminate"}],h=(e,t)=>t.includes("HIV")||t.includes("Test")||t.includes("MRDT")||e.includes("Pregnancy test")||e.includes("vdrl")||e.includes("pocus")||e.includes("ecg")?"radio":e.includes("pH")||e.includes("PCO2")||e.includes("PO2")||e.includes("CK")||e.includes("CNA")||e.includes("glucose")||e.includes("BASE_EXCESS")||e.includes("LACTATE")?"number":"text";var p=l(94049),g=l(25635);let v=e=>{let{formStructure:t}=e,l=b(),n=e=>{if(!e)return null;switch(e.type){case"section":return(0,i.jsxs)(p.default,{sx:{mb:4},children:[(0,i.jsx)(g.default,{variant:"h6",color:"GrayText",sx:{mb:2},children:e.title}),e.items.length>0&&(0,i.jsx)(a.m2,{children:e.items.map(e=>n(e))})]},e.title);case"text":return(0,i.jsx)(a.A8,{id:e.name,name:e.name,label:e.label,multiline:e.multiline,rows:e.multiline?4:1},e.name);case"number":return(0,i.jsx)(a.A8,{id:e.name,name:e.name,label:e.label,type:"number"},e.name);case"radio":return(0,i.jsx)(a.b1,{name:e.name,label:e.label,options:e.options||l},e.name);default:return null}};return(0,i.jsx)(i.Fragment,{children:t.map(e=>n(e))})},y=(e,t)=>{let l=t.flatMap(e=>e.items?e.items:[e]).find(t=>t.name===e);return l&&void 0!==l.obs_id?l.obs_id:null},_=function(e,t){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Date().toISOString(),i={};for(let a in e){let[n,...r]=a.split("_"),o=r.join("_");i[n]||(i[n]=[]),i[n].push({concept:o||a,obsDatetime:l,value:e[a],groupMembers:[{concept:s.W.DESCRIPTION,obsDatetime:l,value:y(a,t)}]})}let a=[];for(let e in i)a.push({concept:s.W.DESCRIPTION||"DESCRIPTION",obsDatetime:l,value:e,groupMembers:i[e]});return a};var x=l(91871);let j=e=>{let{onClose:t}=e,{activeVisit:l,patientId:p}=(0,o.gd)(),{ServerTime:g}=(0,r.useServerTime)(),{mutate:y,isPending:j,isSuccess:E}=(0,d.jM)(),{data:S,isLoading:A}=(0,d.$O)(p,"encounter_type=".concat(s.fA.BED_SIDE_TEST)),{data:D,refetch:C,isLoading:I}=(0,d.$O)(p,"encounter_type=".concat(s.fA.BEDSIDE_INVESTIGATION_PLAN)),{formStructure:T,initialValues:O,validationSchema:B}=((e,t,l)=>{let[i,a]=(0,u.useState)([]),[n,s]=(0,u.useState)({}),[r,o]=(0,u.useState)(f.Ik()),d=(0,u.useCallback)(e=>{let t=[];if(!e||!Array.isArray(e))return t;for(let l of e){(l.value||l.value_text)&&t.push(l.value||l.value_text);let e=d(l.children);t.push(...e)}return t},[]),c=(0,u.useCallback)(e=>{let t=new Set;if(!e||!Array.isArray(e))return t;for(let l of e)d(l.children).forEach(e=>{let l=parseInt(e);isNaN(l)||t.add(l)});return t},[d]),m=(0,u.useCallback)((e,t)=>{if(!e||!Array.isArray(e))return[];let l=[];for(let i of e)if(!t.has(i.obs_id))if(i.children&&Array.isArray(i.children)){let e=m(i.children,t);l.push({...i,children:e})}else l.push(i);return l},[]),p=(0,u.useCallback)((e,t)=>{if(!e||!Array.isArray(e))return[];if(!t||!Array.isArray(t))return e;let l=c(t),i=[];for(let t of e)if(!l.has(t.obs_id))if(t.children&&Array.isArray(t.children)){let e=m(t.children,l);if(0===e.length&&t.children.length>0)continue;i.push({...t,children:e})}else i.push(t);return i},[c,m]);return(0,u.useEffect)(()=>{},[t,l]),(0,u.useEffect)(()=>{if(e&&(null==e?void 0:e.length)>0){var i,n,r,d;let c=[],u={},m={},g={"Arterial Blood Gas_pH":f.ai().min(7.35).max(7.45).label("pH"),"Arterial Blood Gas_PCO2":f.ai().min(35).max(45).label("PCO2"),"Arterial Blood Gas_PO2":f.ai().min(75).max(100).label("PO2"),"Arterial Blood Gas_Base Excess":f.ai().min(-4).max(2).label("Base Excess"),"Arterial Blood Gas_LACTATE":f.ai().min(0).max(2).label("Lactate"),"Arterial Blood Gas_SO2E":f.ai().min(95).max(100).label("SO2E"),"Arterial Blood Gas_P50E":f.ai().min(24).max(28).label("P50E"),"Arterial Blood Gas_HCO3":f.ai().min(3).max(7).label("HCO3"),"Electrolyte Values_CK":f.ai().min(3.5).max(5.5).label("CK"),"Electrolyte Values_CNA":f.ai().min(135).max(145).label("CNA"),"Electrolyte Values_CA2":f.ai().label("CA2"),"Electrolyte Values_CCL":f.ai().label("CCL"),"Electrolyte Values_glucose":f.ai().min(3).max(7).label("Glucose"),"Electrolyte Values_ANION_GAPC":f.ai().label("Anion Gap"),"Electrolyte Values_MOSMC":f.ai().label("MOSMC"),"Electrolyte Values_FO2HBE":f.ai().label("FO2HBE"),"Electrolyte Values_FHHBE":f.ai().label("FHHBE"),Dipstick_urobilinogen:f.Yj().label("Urobilinogen"),Dipstick_leukocytes:f.Yj().label("Leukocytes"),Dipstick_bilirubin:f.Yj().label("Bilirubin"),Dipstick_glucose:f.Yj().label("Glucose"),"Dipstick_Specific Gravity":f.Yj().label("Specific Gravity"),Dipstick_protein:f.Yj().label("Protein"),Dipstick_nitrite:f.Yj().label("Nitrite"),Dipstick_ketones:f.Yj().label("Ketones"),Dipstick_blood:f.Yj().label("Blood"),mrdt:f.Yj().required().label("MRDT"),pregnancyTest:f.Yj().label("Pregnancy test"),hiv:f.Yj().label("HIV"),vdrl:f.Yj().label("VDRL"),pocus:f.Yj().label("POCUS"),ecg:f.Yj().label("ECG"),other:f.Yj().label("Other")},v=null==(r=e[0])?void 0:r.obs.reduce((e,t)=>new Date(t.obs_datetime)>new Date(e)?t.obs_datetime:e,null==(n=e[0])||null==(i=n.obs[0])?void 0:i.obs_datetime),y=null==(d=e[0])?void 0:d.obs.filter(e=>e.obs_datetime===v),_=y;!l&&t&&Array.isArray(t)&&t.length>0&&(console.log("\uD83D\uDE80 ~ useEffect ~ BedSideResults:",t),_=p(y,t[0].obs)),_&&Array.isArray(_)&&_.forEach(e=>{let t=((e,t,l,i)=>{if(!e)return null;let a=b();if(!e.children||0===e.children.length){let n=e.names&&e.names[0]?e.names[e.names.length-1].name:"Field ".concat(e.concept_id),s="".concat(n);t[s]=e.value||"";let r=s.toLowerCase().replace(/\s+/g,"");l[s]=i[s]||i[r]||f.Yj();let o=h(s,n);return"radio"===o?{type:"radio",name:s,label:n,obs_id:e.obs_id,options:a}:{type:o,name:s,label:n,obs_id:e.obs_id,multiline:n.includes("Notes")||n.includes("Description")}}let n=[];return e.children.forEach(a=>{let s=a.names&&a.names[0]?a.names[0].name:"Field ".concat(a.concept_id),r="".concat(e.value,"_").concat(s);t[r]=a.value||"",l[r]=i[r]||f.Yj();let o=h(r,s);n.push({type:o,name:r,label:s,obs_id:a.obs_id})}),{type:"section",title:e.value,items:n}})(e,u,m,g);t&&c.push(t)}),a(c),s(u);try{if(Object.keys(m).length>0){let e=f.Ik().shape(m);o(e)}else o(f.Ik())}catch(e){o(f.Ik())}}},[e,t,l,p]),(0,u.useEffect)(()=>{},[r,n]),{formStructure:i,initialValues:n,validationSchema:r}})(D,S,A);return(0,u.useEffect)(()=>{C()}),(0,u.useEffect)(()=>{E&&m.oR.success("Bedside test submitted successfully!",{position:"top-right",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored",transition:m.br})},[E]),(0,i.jsx)(n.h,{loading:j||A||I,children:(0,i.jsx)(a.PD,{validationSchema:B,onSubmit:e=>{let t=g.getServerTimeString(),i=_(e,T,t);i.length>0&&y({encounterType:s.fA.BED_SIDE_TEST,visit:l,patient:p,encounterDatetime:t,obs:i})},initialValues:{...O},submitButton:!1,children:e=>{let{values:t,submitCount:a}=e;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(c.lV,{children:(0,i.jsx)(v,{formStructure:T})}),a>0?(0,i.jsx)(x.A,{variant:"contained",onClick:()=>(e=>{let t=g.getServerTimeString(),i=_(e,T,t);i.length>0&&y({encounterType:s.fA.BED_SIDE_TEST,visit:l,patient:p,encounterDatetime:t,obs:i})})(t),children:"submit anyway"}):(0,i.jsx)(x.A,{variant:"contained",type:"submit",children:"submit"})]})}})})}},19948:(e,t,l)=>{l.d(t,{v:()=>j});var i=l(95155),a=l(12115),n=l(72478),s=l(45294),r=l(87295),o=l(26301),d=l(35068),c=l(94049),u=l(25635),m=l(17325),f=l(56475),b=l(22822),h=l(263),p=l(66637),g=l(95582),v=l(33115),y=l(90702),_=l(7047);let x=e=>{let{groupedTests:t}=e,{values:l,setFieldValue:n}=(0,g.j7)();return(0,a.useEffect)(()=>{l.selectedLabOrderIds||n("selectedLabOrderIds",[])},[]),(0,i.jsxs)(c.default,{sx:{mt:3,mb:2},children:[(0,i.jsx)(u.default,{variant:"subtitle1",sx:{mb:1},children:"Ordered Tests"}),Object.entries(t).map(e=>{let[t,a]=e;return(0,i.jsxs)(c.default,{sx:{mb:2},children:[(0,i.jsx)(u.default,{variant:"subtitle2",children:t}),(0,i.jsx)(m.A,{children:a.map(e=>{var t;return(0,i.jsx)(f.default,{control:(0,i.jsx)(b.default,{checked:(null==(t=l.selectedLabOrderIds)?void 0:t.includes(e.id))||!1,onChange:()=>(e=>{let t=l.selectedLabOrderIds||[];n("selectedLabOrderIds",t.includes(e)?t.filter(t=>t!==e):[...t,e])})(e.id)}),label:"".concat(e.test," (").concat((0,o.kh)(e.date),")")},e.id)})})]},t)})]})},j=e=>{let{onClose:t,addRequest:l}=e,[o,c]=(0,a.useState)(""),[u,m]=(0,a.useState)({}),{data:f,isLoading:b,isSuccess:g,refetch:j,isRefetching:E}=(0,s.Xt)(),{data:S,isLoading:A,isSuccess:D,refetch:C,isRefetching:I}=(0,s.Jl)(o),[T,O]=(0,a.useState)(""),[B,N]=(0,a.useState)(""),[P,w]=(0,a.useState)(""),{data:k,isLoading:L,refetch:G,isRefetching:R}=(0,s.G5)(B),{data:Y,isLoading:V,refetch:H,isRefetching:M}=(0,s.G5)(P),[F,W]=(0,a.useState)([]),[U,K]=(0,a.useState)([]),{params:$}=(0,r.KU)(),{activeVisit:q,patientId:J}=(0,r.gd)(),{mutate:X,isPending:z,isSuccess:Q}=(0,s.fS)(),{selectedVisit:Z}=(0,_.E)(),{data:ee,refetch:et}=(0,p.$O)(null==$?void 0:$.id,"encounter_type=".concat(h.fA.LAB_ORDERS_PLAN,"&visit=").concat(null==Z?void 0:Z.uuid)),{data:el,refetch:ei}=(0,p.$O)(null==$?void 0:$.id,"encounter_type=".concat(h.fA.LAB,"&visit=").concat(null==Z?void 0:Z.uuid));(0,a.useEffect)(()=>{C()},[o]),(0,a.useEffect)(()=>{G()},[B]),(0,a.useEffect)(()=>{et(),ei()},[]),(0,a.useEffect)(()=>{k&&W(ea())},[k]),(0,a.useEffect)(()=>{f&&W(f)},[f,E]),(0,a.useEffect)(()=>{H()},[P]),(0,a.useEffect)(()=>{K(en())},[Y]),(0,a.useEffect)(()=>{S&&K(S)},[S]);let ea=()=>k?k.map(e=>({...e,names:e.names,name:e.names[0].name})).sort((e,t)=>e.name.localeCompare(t.name)):[],en=()=>{if(!Y)return[];let e=["Random Blood Glucose (RBS)","Fasting Blood Glucose (FBS)","H. Pylori","C-Reactive Protein (CRP)","Haemoglobin","Pregnancy Test","HIV","C-reactive protein","Malaria Screening","Blood Gas","Urine Chemistries"].map(e=>e.toLowerCase());return Y.filter(e=>e.names.length>0&&e.names.some(e=>null==e?void 0:e.name)).map(e=>{var t;return{...e,name:(null==(t=e.names.find(e=>null==e?void 0:e.name))?void 0:t.name)||""}}).sort((e,t)=>e.name.localeCompare(t.name)).filter(t=>{var l;return e.includes(null==(l=t.name)?void 0:l.toLowerCase())})};(0,a.useEffect)(()=>{Q&&(v.oR.success("Test submitted successfully!",{position:"top-right",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored",transition:v.br}),t())},[Q]);let es=async e=>{let t=e.selectedLabOrderIds||[],l=Object.entries(er.filter(e=>t.includes(e.id)).map(e=>({testName:e.test,testId:e.id,specimenType:e.specimen,date:e.date,...(null==e?void 0:e.comment_to_fulfiller)?{comment_to_fulfiller:e.comment_to_fulfiller}:{}})).reduce((e,t)=>{let l="".concat(t.specimenType,"|").concat(t.date);return e[l]||(e[l]=[]),e[l].push(t),e},{})).map(async e=>{let[t,l]=e,[i,a]=t.split("|"),n=await Promise.all(l.map(async e=>({concept:await (0,p.cr)(e.testName).then(e=>e.data[0].uuid)}))),s=await (0,p.cr)(i).then(e=>e.data[0].uuid);return{patient:J,visit:q,tests:n,reason_for_test:"b998cdac-8d80-11d8-abbb-0024217bb78e",target_lab:"Blantyre Dream Project Clinic",date:a,requesting_clinician:localStorage.getItem("userName"),comment_to_fulfiller:l[0].comment_to_fulfiller||"",specimen:{concept:s,specimenType:i}}});X({orders:await Promise.all(l)}),et(),ei()},er=[];if(ee&&(null==ee?void 0:ee.length)>0){var eo,ed;er=null==(ed=ee[0])||null==(eo=ed.obs)?void 0:eo.flatMap(e=>e.children.map(t=>{let l;return t.children&&t.children.length>0&&(l=t.children.find(e=>e.names.find(e=>e.name==h.W.DESCRIPTION))),{test:t.names[0].name,testConceptId:t.concept_id,date:e.obs_datetime,specimen:e.names[0].name,id:t.obs_id,...l?{comment_to_fulfiller:null==l?void 0:l.value}:{}}})),el&&(null==el?void 0:el.length)>0&&(er=((e,t)=>{let l=new Map;return t.forEach(e=>{e.obs.forEach(e=>{if(null!==e.value_coded){let t="".concat(e.value_coded,"_").concat(e.obs_datetime);l.set(t,!0)}})}),e.filter(e=>{let t="".concat(e.testConceptId,"_").concat(e.date);return!l.has(t)})})(er,el))}let ec=er.reduce((e,t)=>{let l=t.specimen;return e[l]||(e[l]=[]),e[l].push(t),e},{});return(0,i.jsx)(y.h,{loading:z,children:(0,i.jsx)(n.PD,{initialValues:{testType:"",sampleType:"",selectedLabOrderIds:[]},onSubmit:es,validationSchema:d.Ik().shape({selectedLabOrderIds:d.YO().of(d.ai())}),children:er.length>0&&(0,i.jsx)(x,{groupedTests:ec})})})}},36011:(e,t,l)=>{l.d(t,{A:()=>p});var i=l(95155),a=l(72478),n=l(12115),s=l(8155),r=l(25635),o=l(91871),d=l(66637),c=l(33115),u=l(87295),m=l(5387),f=l(263),b=l(25641),h=l(8282);let p=function(e){let{conceptType:t}=e,[l,p]=(0,n.useState)([]),{mutate:g,isSuccess:v,isError:y}=(0,d.jM)(),{params:_}=(0,u.KU)(),{data:x}=(0,m.GN)(_.id),[j,E]=(0,n.useState)(void 0),[S,A]=(0,n.useState)(!1),[D,C]=(0,n.useState)({}),[I,T]=(0,n.useState)(!1),{data:O}=(0,m.iu)(_.id),{data:B,refetch:N}=(0,d.$O)(_.id,"encounter_type=".concat(f.fA.OUTPATIENT_DIAGNOSIS)),{mutate:P}=(0,d.tI)(),{init:w,ServerTime:k}=(0,b.useServerTime)();return(0,n.useEffect)(()=>{if(O){let e=O.find(e=>!e.date_stopped);e&&E(e)}},[O]),(0,n.useEffect)(()=>{B&&p(B.flatMap(e=>e.obs.filter(e=>{var l;return(null==(l=e.names[0])?void 0:l.name)===t}).map(e=>{var t;return{id:e.obs_id.toString(),condition:null!=(t=e.value_text)?t:"",obsDatetime:e.obs_datetime||""}})))},[B,t]),(0,i.jsxs)(a.Yr,{container:!0,spacing:2,children:[(0,i.jsx)(a.Yr,{item:!0,xs:12,children:(0,i.jsxs)(a.sc,{style:{padding:"20px"},children:[(0,i.jsx)(r.default,{variant:"subtitle1",style:{marginBottom:"10px",fontWeight:"500"},children:"Current Diagnosis"}),(0,i.jsx)("br",{}),(0,i.jsxs)("div",{style:{display:"flex",paddingBottom:"8px",borderBottom:"1px solid #ddd"},children:[(0,i.jsx)(r.default,{variant:"body2",style:{width:"40%",fontWeight:"500"},children:"Condition"}),(0,i.jsx)(r.default,{variant:"body2",style:{width:"25%",fontWeight:"500"},children:"Diagnosis Type"}),(0,i.jsx)(r.default,{variant:"body2",style:{width:"25%",fontWeight:"500"},children:"Date"}),(0,i.jsx)(r.default,{variant:"body2",style:{width:"10%",fontWeight:"500"},children:"Action"})]}),0===l.length?(0,i.jsx)(r.default,{variant:"body2",style:{padding:"16px",textAlign:"center",color:"gray"},children:"No Diagnosis Added"}):l.slice(-3).map(e=>(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",borderBottom:"1px solid #f0f0f0"},children:[(0,i.jsx)(r.default,{variant:"body2",style:{width:"40%"},children:e.condition}),(0,i.jsx)(r.default,{variant:"body2",style:{width:"25%",fontStyle:"italic"},children:t===f.W.DIFFERENTIAL_DIAGNOSIS?"Differential Diagnosis":"Final Diagnosis"}),(0,i.jsx)(r.default,{variant:"body2",style:{width:"25%"},children:new Date(e.obsDatetime).toLocaleDateString("en-GB")}),(0,i.jsx)(r.default,{variant:"body2",style:{width:"10%"},children:(0,i.jsx)(o.A,{onClick:()=>{var t;P(t=e.id,{onSuccess:()=>{p(e=>e.filter(e=>e.id!==t))},onError:()=>{console.error("Error deleting diagnosis")}})},size:"small",color:"error",variant:"text",children:"Delete"})})]},e.id)),(0,i.jsx)(r.default,{variant:"subtitle2",style:{color:"green",cursor:"pointer",marginTop:"30px"},onClick:()=>T(!I),children:I?"- Cancel New Diagnosis":"+ Add New Diagnosis"}),I&&(0,i.jsx)(h.default,{label:"Select Diagnosis",initialValue:"",onSelection:e=>{let l=k.getServerTimeString();e&&(null==j?void 0:j.uuid)?g({encounterType:f.fA.OUTPATIENT_DIAGNOSIS,visit:null==j?void 0:j.uuid,patient:_.id,encounterDatetime:l,obs:[{concept:t,value:"".concat(e.code," - ").concat(e.diagnosis),obsDatetime:l}]},{onSuccess:async()=>{await N()},onError:()=>{c.oR.error("Failed to submit diagnosis.")}}):c.oR.error("Visit information is missing, cannot add diagnosis.")},placeholder:"Start typing to search diagnoses..."})]})}),(0,i.jsx)(a.Yr,{item:!0,xs:12,children:(0,i.jsxs)(a.sc,{children:[(0,i.jsx)(r.default,{onClick:()=>A(!S),variant:"subtitle1",style:{cursor:"pointer",padding:"1ch",fontWeight:"500"},children:S?"Hide Previous Diagnosis":"Show Previous Diagnosis"}),S&&(0,i.jsx)(s.c,{diagnoses:l})]})})]})}},89204:(e,t,l)=>{l.d(t,{$:()=>d});var i=l(95155),a=l(13372),n=l(19948),s=l(80089),r=l(80064),o=l(29940);function d(e){let{onClose:t}=e,l=[{id:"bedside",title:"Bedside",content:(0,i.jsx)(a.J,{onClose:()=>{null==t||t()}})},{id:"labForm",title:"Lab orders",content:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.v,{onClose:()=>{},addRequest:()=>{}}),(0,i.jsx)(s.M,{})]})},{id:"radiology",title:"Radiology (Coming Soon)",content:(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(o.h,{})})}];return(0,i.jsx)(r.M,{sections:l})}}}]);