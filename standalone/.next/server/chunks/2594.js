"use strict";exports.id=2594,exports.ids=[2594],exports.modules={93:(e,t,i)=>{i.d(t,{v:()=>S});var l=i(60687),a=i(43210),s=i(75018),n=i(42533),r=i(61939),o=i(88794),d=i(30485),c=i(28274),u=i(78590),m=i(94584),f=i(70166),b=i(4072),h=i(42938),p=i(62116),g=i(62085),y=i(96851),x=i(60931),_=i(94482);let j=({groupedTests:e})=>{let{values:t,setFieldValue:i}=(0,g.j7)();(0,a.useEffect)(()=>{t.selectedLabOrderIds||i("selectedLabOrderIds",[])},[]);let s=e=>{let l,a=t.selectedLabOrderIds||[];i("selectedLabOrderIds",a.includes(e)?a.filter(t=>t!==e):[...a,e])};return(0,l.jsxs)(c.default,{sx:{mt:3,mb:2},children:[(0,l.jsx)(u.default,{variant:"subtitle1",sx:{mb:1},children:"Ordered Tests"}),Object.entries(e).map(([e,i])=>(0,l.jsxs)(c.default,{sx:{mb:2},children:[(0,l.jsx)(u.default,{variant:"subtitle2",children:e}),(0,l.jsx)(m.A,{children:i.map(e=>(0,l.jsx)(f.default,{control:(0,l.jsx)(b.default,{checked:t.selectedLabOrderIds?.includes(e.id)||!1,onChange:()=>s(e.id)}),label:`${e.test} (${(0,o.kh)(e.date)})`},e.id))})]},e))]})},S=({onClose:e,addRequest:t})=>{let[i,o]=(0,a.useState)(""),[c,u]=(0,a.useState)({}),{data:m,isLoading:f,isSuccess:b,refetch:g,isRefetching:S}=(0,n.Xt)(),{data:v,isLoading:E,isSuccess:A,refetch:D,isRefetching:C}=(0,n.Jl)(i),[I,T]=(0,a.useState)(""),[O,B]=(0,a.useState)(""),[N,P]=(0,a.useState)(""),{data:w,isLoading:L,refetch:k,isRefetching:G}=(0,n.G5)(O),{data:$,isLoading:R,refetch:Y,isRefetching:V}=(0,n.G5)(N),[H,F]=(0,a.useState)([]),[M,W]=(0,a.useState)([]),{params:U}=(0,r.KU)(),{activeVisit:K,patientId:q}=(0,r.gd)(),{mutate:J,isPending:X,isSuccess:z}=(0,n.fS)(),{selectedVisit:Q}=(0,_.E)(),{data:Z,refetch:ee}=(0,p.$O)(U?.id,`encounter_type=${h.fA.LAB_ORDERS_PLAN}&visit=${Q?.uuid}`),{data:et,refetch:ei}=(0,p.$O)(U?.id,`encounter_type=${h.fA.LAB}&visit=${Q?.uuid}`);(0,a.useEffect)(()=>{D()},[i]),(0,a.useEffect)(()=>{k()},[O]),(0,a.useEffect)(()=>{ee(),ei()},[]),(0,a.useEffect)(()=>{w&&F(el())},[w]),(0,a.useEffect)(()=>{m&&F(m)},[m,S]),(0,a.useEffect)(()=>{Y()},[N]),(0,a.useEffect)(()=>{W(ea())},[$]),(0,a.useEffect)(()=>{v&&W(v)},[v]);let el=()=>w?w.map(e=>({...e,names:e.names,name:e.names[0].name})).sort((e,t)=>e.name.localeCompare(t.name)):[],ea=()=>{if(!$)return[];let e=["Random Blood Glucose (RBS)","Fasting Blood Glucose (FBS)","H. Pylori","C-Reactive Protein (CRP)","Haemoglobin","Pregnancy Test","HIV","C-reactive protein","Malaria Screening","Blood Gas","Urine Chemistries"].map(e=>e.toLowerCase());return $.filter(e=>e.names.length>0&&e.names.some(e=>e?.name)).map(e=>({...e,name:e.names.find(e=>e?.name)?.name||""})).sort((e,t)=>e.name.localeCompare(t.name)).filter(t=>e.includes(t.name?.toLowerCase()))};(0,a.useEffect)(()=>{z&&(y.oR.success("Test submitted successfully!",{position:"top-right",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored",transition:y.br}),e())},[z]);let es=async e=>{let t=e.selectedLabOrderIds||[],i=Object.entries(en.filter(e=>t.includes(e.id)).map(e=>({testName:e.test,testId:e.id,specimenType:e.specimen,date:e.date,...e?.comment_to_fulfiller?{comment_to_fulfiller:e.comment_to_fulfiller}:{}})).reduce((e,t)=>{let i=`${t.specimenType}|${t.date}`;return e[i]||(e[i]=[]),e[i].push(t),e},{})).map(async([e,t])=>{let[i,l]=e.split("|"),a=await Promise.all(t.map(async e=>({concept:await (0,p.cr)(e.testName).then(e=>e.data[0].uuid)}))),s=await (0,p.cr)(i).then(e=>e.data[0].uuid);return{patient:q,visit:K,tests:a,reason_for_test:"b998cdac-8d80-11d8-abbb-0024217bb78e",target_lab:"Blantyre Dream Project Clinic",date:l,requesting_clinician:localStorage.getItem("userName"),comment_to_fulfiller:t[0].comment_to_fulfiller||"",specimen:{concept:s,specimenType:i}}});J({orders:await Promise.all(i)}),ee(),ei()},en=[];Z&&Z?.length>0&&(en=Z[0]?.obs?.flatMap(e=>e.children.map(t=>{let i;return t.children&&t.children.length>0&&(i=t.children.find(e=>e.names.find(e=>e.name==h.W.DESCRIPTION))),{test:t.names[0].name,testConceptId:t.concept_id,date:e.obs_datetime,specimen:e.names[0].name,id:t.obs_id,...i?{comment_to_fulfiller:i?.value}:{}}})),et&&et?.length>0&&(en=((e,t)=>{let i=new Map;return t.forEach(e=>{e.obs.forEach(e=>{if(null!==e.value_coded){let t=`${e.value_coded}_${e.obs_datetime}`;i.set(t,!0)}})}),e.filter(e=>{let t=`${e.testConceptId}_${e.date}`;return!i.has(t)})})(en,et)));let er=en.reduce((e,t)=>{let i=t.specimen;return e[i]||(e[i]=[]),e[i].push(t),e},{});return(0,l.jsx)(x.h,{loading:X,children:(0,l.jsx)(s.PD,{initialValues:{testType:"",sampleType:"",selectedLabOrderIds:[]},onSubmit:es,validationSchema:d.Ik().shape({selectedLabOrderIds:d.YO().of(d.ai())}),children:en.length>0&&(0,l.jsx)(j,{groupedTests:er})})})}},11005:(e,t,i)=>{i.d(t,{J:()=>A});var l=i(60687),a=i(75018),s=i(60931),n=i(42938),r=i(44504),o=i(61939),d=i(62116),c=i(62085),u=i(43210),m=i(96851),f=i(30485);let b=()=>({"Arterial Blood Gas_pH":f.ai().min(7.35).max(7.45).label("pH"),"Arterial Blood Gas_PCO2":f.ai().min(35).max(45).label("PCO2"),"Arterial Blood Gas_PO2":f.ai().min(75).max(100).label("PO2"),"Arterial Blood Gas_Base Excess":f.ai().min(-4).max(2).label("Base Excess"),"Arterial Blood Gas_LACTATE":f.ai().min(0).max(2).label("Lactate"),"Arterial Blood Gas_SO2E":f.ai().min(95).max(100).label("SO2E"),"Arterial Blood Gas_P50E":f.ai().min(24).max(28).label("P50E"),"Arterial Blood Gas_HCO3":f.ai().min(3).max(7).label("HCO3"),"Electrolyte Values_CK":f.ai().min(3.5).max(5.5).label("CK"),"Electrolyte Values_CNA":f.ai().min(135).max(145).label("CNA"),"Electrolyte Values_CA2":f.ai().label("CA2"),"Electrolyte Values_CCL":f.ai().label("CCL"),"Electrolyte Values_glucose":f.ai().min(3).max(7).label("Glucose"),"Electrolyte Values_ANION_GAPC":f.ai().label("Anion Gap"),"Electrolyte Values_MOSMC":f.ai().label("MOSMC"),"Electrolyte Values_FO2HBE":f.ai().label("FO2HBE"),"Electrolyte Values_FHHBE":f.ai().label("FHHBE"),Dipstick_urobilinogen:f.Yj().label("Urobilinogen"),Dipstick_leukocytes:f.Yj().label("Leukocytes"),Dipstick_bilirubin:f.Yj().label("Bilirubin"),Dipstick_glucose:f.Yj().label("Glucose"),"Dipstick_Specific Gravity":f.Yj().label("Specific Gravity"),Dipstick_protein:f.Yj().label("Protein"),Dipstick_nitrite:f.Yj().label("Nitrite"),Dipstick_ketones:f.Yj().label("Ketones"),Dipstick_blood:f.Yj().label("Blood"),mrdt:f.Yj().required().label("MRDT"),pregnancyTest:f.Yj().label("Pregnancy test"),hiv:f.Yj().label("HIV"),vdrl:f.Yj().label("VDRL"),pocus:f.Yj().label("POCUS"),ecg:f.Yj().label("ECG"),other:f.Yj().label("Other")}),h=()=>[{value:n.W.POSITIVE,label:"Positive"},{value:n.W.NEGATIVE,label:"Negative"},{value:n.W.INDETERMINATE,label:"Indeterminate"}],p=(e,t)=>t.includes("HIV")||t.includes("Test")||t.includes("MRDT")||e.includes("Pregnancy test")||e.includes("vdrl")||e.includes("pocus")||e.includes("ecg")?"radio":e.includes("pH")||e.includes("PCO2")||e.includes("PO2")||e.includes("CK")||e.includes("CNA")||e.includes("glucose")||e.includes("BASE_EXCESS")||e.includes("LACTATE")?"number":"text",g=(e,t,i,l)=>{if(!e)return null;let a=h();if(!e.children||0===e.children.length){let s=e.names&&e.names[0]?e.names[e.names.length-1].name:`Field ${e.concept_id}`,n=`${s}`;t[n]=e.value||"";let r=n.toLowerCase().replace(/\s+/g,"");i[n]=l[n]||l[r]||f.Yj();let o=p(n,s);return"radio"===o?{type:"radio",name:n,label:s,obs_id:e.obs_id,options:a}:{type:o,name:n,label:s,obs_id:e.obs_id,multiline:s.includes("Notes")||s.includes("Description")}}let s=[];return e.children.forEach(a=>{let n=a.names&&a.names[0]?a.names[0].name:`Field ${a.concept_id}`,r=`${e.value}_${n}`;t[r]=a.value||"",i[r]=l[r]||f.Yj();let o=p(r,n);s.push({type:o,name:r,label:n,obs_id:a.obs_id})}),{type:"section",title:e.value,items:s}},y=(e,t,i)=>{let[l,a]=(0,u.useState)([]),[s,n]=(0,u.useState)({}),[r,o]=(0,u.useState)(f.Ik()),d=(0,u.useCallback)(e=>{let t=[];if(!e||!Array.isArray(e))return t;for(let i of e){(i.value||i.value_text)&&t.push(i.value||i.value_text);let e=d(i.children);t.push(...e)}return t},[]),c=(0,u.useCallback)(e=>{let t=new Set;if(!e||!Array.isArray(e))return t;for(let i of e)d(i.children).forEach(e=>{let i=parseInt(e);isNaN(i)||t.add(i)});return t},[d]),m=(0,u.useCallback)((e,t)=>{if(!e||!Array.isArray(e))return[];let i=[];for(let l of e)if(!t.has(l.obs_id))if(l.children&&Array.isArray(l.children)){let e=m(l.children,t);i.push({...l,children:e})}else i.push(l);return i},[]),h=(0,u.useCallback)((e,t)=>{if(!e||!Array.isArray(e))return[];if(!t||!Array.isArray(t))return e;let i=c(t),l=[];for(let t of e)if(!i.has(t.obs_id))if(t.children&&Array.isArray(t.children)){let e=m(t.children,i);if(0===e.length&&t.children.length>0)continue;l.push({...t,children:e})}else l.push(t);return l},[c,m]);return(0,u.useEffect)(()=>{},[t,i]),(0,u.useEffect)(()=>{if(e&&e?.length>0){let l=[],s={},r={},d=b(),c=e[0]?.obs.reduce((e,t)=>new Date(t.obs_datetime)>new Date(e)?t.obs_datetime:e,e[0]?.obs[0]?.obs_datetime),u=e[0]?.obs.filter(e=>e.obs_datetime===c),m=u;!i&&t&&Array.isArray(t)&&t.length>0&&(console.log("\uD83D\uDE80 ~ useEffect ~ BedSideResults:",t),m=h(u,t[0].obs)),m&&Array.isArray(m)&&m.forEach(e=>{let t=g(e,s,r,d);t&&l.push(t)}),a(l),n(s);try{if(Object.keys(r).length>0){let e=f.Ik().shape(r);o(e)}else o(f.Ik())}catch(e){o(f.Ik())}}},[e,t,i,h]),(0,u.useEffect)(()=>{},[r,s]),{formStructure:l,initialValues:s,validationSchema:r}};var x=i(28274),_=i(78590);let j=({formStructure:e})=>{let t=h(),i=e=>{if(!e)return null;switch(e.type){case"section":return(0,l.jsxs)(x.default,{sx:{mb:4},children:[(0,l.jsx)(_.default,{variant:"h6",color:"GrayText",sx:{mb:2},children:e.title}),e.items.length>0&&(0,l.jsx)(a.m2,{children:e.items.map(e=>i(e))})]},e.title);case"text":return(0,l.jsx)(a.A8,{id:e.name,name:e.name,label:e.label,multiline:e.multiline,rows:e.multiline?4:1},e.name);case"number":return(0,l.jsx)(a.A8,{id:e.name,name:e.name,label:e.label,type:"number"},e.name);case"radio":return(0,l.jsx)(a.b1,{name:e.name,label:e.label,options:e.options||t},e.name);default:return null}};return(0,l.jsx)(l.Fragment,{children:e.map(e=>i(e))})},S=(e,t)=>{let i=t.flatMap(e=>e.items?e.items:[e]).find(t=>t.name===e);return i&&void 0!==i.obs_id?i.obs_id:null},v=(e,t,i=new Date().toISOString())=>{let l={};for(let a in e){let[s,...r]=a.split("_"),o=r.join("_");l[s]||(l[s]=[]),l[s].push({concept:o||a,obsDatetime:i,value:e[a],groupMembers:[{concept:n.W.DESCRIPTION,obsDatetime:i,value:S(a,t)}]})}let a=[];for(let e in l)a.push({concept:n.W.DESCRIPTION||"DESCRIPTION",obsDatetime:i,value:e,groupMembers:l[e]});return a};var E=i(50772);let A=({onClose:e})=>{let{activeVisit:t,patientId:i}=(0,o.gd)(),{ServerTime:f}=(0,r.useServerTime)(),{mutate:b,isPending:h,isSuccess:p}=(0,d.jM)(),{data:g,isLoading:x}=(0,d.$O)(i,`encounter_type=${n.fA.BED_SIDE_TEST}`),{data:_,refetch:S,isLoading:A}=(0,d.$O)(i,`encounter_type=${n.fA.BEDSIDE_INVESTIGATION_PLAN}`),{formStructure:D,initialValues:C,validationSchema:I}=y(_,g,x);(0,u.useEffect)(()=>{S()}),(0,u.useEffect)(()=>{p&&m.oR.success("Bedside test submitted successfully!",{position:"top-right",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored",transition:m.br})},[p]);let T=e=>{let l=f.getServerTimeString(),a=v(e,D,l);a.length>0&&b({encounterType:n.fA.BED_SIDE_TEST,visit:t,patient:i,encounterDatetime:l,obs:a})};return(0,l.jsx)(s.h,{loading:h||x||A,children:(0,l.jsx)(a.PD,{validationSchema:I,onSubmit:e=>{let l=f.getServerTimeString(),a=v(e,D,l);a.length>0&&b({encounterType:n.fA.BED_SIDE_TEST,visit:t,patient:i,encounterDatetime:l,obs:a})},initialValues:{...C},submitButton:!1,children:({values:e,submitCount:t})=>(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(c.lV,{children:(0,l.jsx)(j,{formStructure:D})}),t>0?(0,l.jsx)(E.A,{variant:"contained",onClick:()=>T(e),children:"submit anyway"}):(0,l.jsx)(E.A,{variant:"contained",type:"submit",children:"submit"})]})})})}},40446:(e,t,i)=>{i.d(t,{c:()=>s});var l=i(60687);i(43210);var a=i(75018);let s=({diagnoses:e})=>{let t=[{field:"condition",headerName:"Diagnosis",flex:1},{field:"label",headerName:"Diagnosis Type ",flex:1,renderCell:()=>(0,l.jsx)("span",{children:"Differential Diagnosis"})},{field:"obsDatetime",headerName:"Date Recorded",flex:1,renderCell:e=>{let t=e.row.obsDatetime;return(0,l.jsx)("span",{children:t?new Date(t).toLocaleDateString():"N/A"})}}];return(0,l.jsx)(a.WE,{rows:e,columns:t,height:"400px",width:"100%",showTopBar:!1})}},47541:(e,t,i)=>{i.d(t,{$:()=>d});var l=i(60687),a=i(11005),s=i(93),n=i(51040),r=i(35009),o=i(14989);function d({onClose:e}){let t=[{id:"bedside",title:"Bedside",content:(0,l.jsx)(a.J,{onClose:()=>{e?.()}})},{id:"labForm",title:"Lab orders",content:(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.v,{onClose:()=>{},addRequest:()=>{}}),(0,l.jsx)(n.M,{})]})},{id:"radiology",title:"Radiology (Coming Soon)",content:(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(o.h,{})})}];return(0,l.jsx)(r.M,{sections:t})}},88806:(e,t,i)=>{i.d(t,{A:()=>p});var l=i(60687),a=i(75018),s=i(43210),n=i(40446),r=i(78590),o=i(50772),d=i(62116),c=i(96851),u=i(61939),m=i(76990),f=i(42938),b=i(44504),h=i(40987);let p=function({conceptType:e}){let[t,i]=(0,s.useState)([]),{mutate:p,isSuccess:g,isError:y}=(0,d.jM)(),{params:x}=(0,u.KU)(),{data:_}=(0,m.GN)(x.id),[j,S]=(0,s.useState)(void 0),[v,E]=(0,s.useState)(!1),[A,D]=(0,s.useState)({}),[C,I]=(0,s.useState)(!1),{data:T}=(0,m.iu)(x.id),{data:O,refetch:B}=(0,d.$O)(x.id,`encounter_type=${f.fA.OUTPATIENT_DIAGNOSIS}`),{mutate:N}=(0,d.tI)(),{init:P,ServerTime:w}=(0,b.useServerTime)(),L=e=>{N(e,{onSuccess:()=>{i(t=>t.filter(t=>t.id!==e))},onError:()=>{console.error("Error deleting diagnosis")}})};return(0,l.jsxs)(a.Yr,{container:!0,spacing:2,children:[(0,l.jsx)(a.Yr,{item:!0,xs:12,children:(0,l.jsxs)(a.sc,{style:{padding:"20px"},children:[(0,l.jsx)(r.default,{variant:"subtitle1",style:{marginBottom:"10px",fontWeight:"500"},children:"Current Diagnosis"}),(0,l.jsx)("br",{}),(0,l.jsxs)("div",{style:{display:"flex",paddingBottom:"8px",borderBottom:"1px solid #ddd"},children:[(0,l.jsx)(r.default,{variant:"body2",style:{width:"40%",fontWeight:"500"},children:"Condition"}),(0,l.jsx)(r.default,{variant:"body2",style:{width:"25%",fontWeight:"500"},children:"Diagnosis Type"}),(0,l.jsx)(r.default,{variant:"body2",style:{width:"25%",fontWeight:"500"},children:"Date"}),(0,l.jsx)(r.default,{variant:"body2",style:{width:"10%",fontWeight:"500"},children:"Action"})]}),0===t.length?(0,l.jsx)(r.default,{variant:"body2",style:{padding:"16px",textAlign:"center",color:"gray"},children:"No Diagnosis Added"}):t.slice(-3).map(t=>(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",borderBottom:"1px solid #f0f0f0"},children:[(0,l.jsx)(r.default,{variant:"body2",style:{width:"40%"},children:t.condition}),(0,l.jsx)(r.default,{variant:"body2",style:{width:"25%",fontStyle:"italic"},children:e===f.W.DIFFERENTIAL_DIAGNOSIS?"Differential Diagnosis":"Final Diagnosis"}),(0,l.jsx)(r.default,{variant:"body2",style:{width:"25%"},children:new Date(t.obsDatetime).toLocaleDateString("en-GB")}),(0,l.jsx)(r.default,{variant:"body2",style:{width:"10%"},children:(0,l.jsx)(o.A,{onClick:()=>L(t.id),size:"small",color:"error",variant:"text",children:"Delete"})})]},t.id)),(0,l.jsx)(r.default,{variant:"subtitle2",style:{color:"green",cursor:"pointer",marginTop:"30px"},onClick:()=>I(!C),children:C?"- Cancel New Diagnosis":"+ Add New Diagnosis"}),C&&(0,l.jsx)(h.default,{label:"Select Diagnosis",initialValue:"",onSelection:t=>{let i=w.getServerTimeString();t&&j?.uuid?p({encounterType:f.fA.OUTPATIENT_DIAGNOSIS,visit:j?.uuid,patient:x.id,encounterDatetime:i,obs:[{concept:e,value:`${t.code} - ${t.diagnosis}`,obsDatetime:i}]},{onSuccess:async()=>{await B()},onError:()=>{c.oR.error("Failed to submit diagnosis.")}}):c.oR.error("Visit information is missing, cannot add diagnosis.")},placeholder:"Start typing to search diagnoses..."})]})}),(0,l.jsx)(a.Yr,{item:!0,xs:12,children:(0,l.jsxs)(a.sc,{children:[(0,l.jsx)(r.default,{onClick:()=>E(!v),variant:"subtitle1",style:{cursor:"pointer",padding:"1ch",fontWeight:"500"},children:v?"Hide Previous Diagnosis":"Show Previous Diagnosis"}),v&&(0,l.jsx)(n.c,{diagnoses:t})]})})]})}}};