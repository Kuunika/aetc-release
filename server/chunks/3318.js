"use strict";exports.id=3318,exports.ids=[3318],exports.modules={51666:(a,b,c)=>{c.d(b,{$:()=>j});var d=c(21124),e=c(80345),f=c(57760),g=c(31393),h=c(38634),i=c(20572);function j({onClose:a}){let b=[{id:"bedside",title:"Bedside",content:(0,d.jsx)(e.J,{onClose:()=>{a?.()}})},{id:"labForm",title:"Lab orders",content:(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(f.v,{onClose:()=>{},addRequest:()=>{}}),(0,d.jsx)(g.M,{})]})},{id:"radiology",title:"Radiology (Coming Soon)",content:(0,d.jsx)(d.Fragment,{children:(0,d.jsx)(i.h,{})})}];return(0,d.jsx)(h.M,{sections:b})}},57760:(a,b,c)=>{c.d(b,{v:()=>w});var d=c(21124),e=c(38301),f=c(80350),g=c(39739),h=c(82283),i=c(38736),j=c(48936),k=c(81637),l=c(79515),m=c(73520),n=c(80155),o=c(77028),p=c(95745),q=c(50852),r=c(16776),s=c(12781),t=c(24390),u=c(12541);let v=({groupedTests:a})=>{let{values:b,setFieldValue:c}=(0,r.j7)();return(0,e.useEffect)(()=>{b.selectedLabOrderIds||c("selectedLabOrderIds",[])},[]),(0,d.jsxs)(k.default,{sx:{mt:3,mb:2},children:[(0,d.jsx)(l.default,{variant:"subtitle1",sx:{mb:1},children:"Ordered Tests"}),Object.entries(a).map(([a,e])=>(0,d.jsxs)(k.default,{sx:{mb:2},children:[(0,d.jsx)(l.default,{variant:"subtitle2",children:a}),(0,d.jsx)(m.A,{children:e.map(a=>(0,d.jsx)(n.default,{control:(0,d.jsx)(o.default,{checked:b.selectedLabOrderIds?.includes(a.id)||!1,onChange:()=>(a=>{let d=b.selectedLabOrderIds||[];c("selectedLabOrderIds",d.includes(a)?d.filter(b=>b!==a):[...d,a])})(a.id)}),label:`${a.test} (${(0,i.kh)(a.date)})`},a.id))})]},a))]})},w=({onClose:a,addRequest:b})=>{let[c,i]=(0,e.useState)(""),[k,l]=(0,e.useState)({}),{data:m,isLoading:n,isSuccess:o,refetch:r,isRefetching:w}=(0,g.Xt)(),{data:x,isLoading:y,isSuccess:z,refetch:A,isRefetching:B}=(0,g.Jl)(c),[C,D]=(0,e.useState)(""),[E,F]=(0,e.useState)(""),[G,H]=(0,e.useState)(""),{data:I,isLoading:J,refetch:K,isRefetching:L}=(0,g.G5)(E),{data:M,isLoading:N,refetch:O,isRefetching:P}=(0,g.G5)(G),[Q,R]=(0,e.useState)([]),[S,T]=(0,e.useState)([]),{params:U}=(0,h.KU)(),{activeVisit:V,patientId:W}=(0,h.gd)(),{mutate:X,isPending:Y,isSuccess:Z}=(0,g.fS)(),{selectedVisit:$}=(0,u.E)(),{data:_,refetch:aa}=(0,q.$O)(U?.id,`encounter_type=${p.fA.LAB_ORDERS_PLAN}&visit=${$?.uuid}`),{data:ab,refetch:ac}=(0,q.$O)(U?.id,`encounter_type=${p.fA.LAB}&visit=${$?.uuid}`);(0,e.useEffect)(()=>{A()},[c]),(0,e.useEffect)(()=>{K()},[E]),(0,e.useEffect)(()=>{aa(),ac()},[]),(0,e.useEffect)(()=>{I&&R(ad())},[I]),(0,e.useEffect)(()=>{m&&R(m)},[m,w]),(0,e.useEffect)(()=>{O()},[G]),(0,e.useEffect)(()=>{T(ae())},[M]),(0,e.useEffect)(()=>{x&&T(x)},[x]);let ad=()=>I?I.map(a=>({...a,names:a.names,name:a.names[0].name})).sort((a,b)=>a.name.localeCompare(b.name)):[],ae=()=>{if(!M)return[];let a=["Random Blood Glucose (RBS)","Fasting Blood Glucose (FBS)","H. Pylori","C-Reactive Protein (CRP)","Haemoglobin","Pregnancy Test","HIV","C-reactive protein","Malaria Screening","Blood Gas","Urine Chemistries"].map(a=>a.toLowerCase());return M.filter(a=>a.names.length>0&&a.names.some(a=>a?.name)).map(a=>({...a,name:a.names.find(a=>a?.name)?.name||""})).sort((a,b)=>a.name.localeCompare(b.name)).filter(b=>a.includes(b.name?.toLowerCase()))};(0,e.useEffect)(()=>{Z&&(s.oR.success("Test submitted successfully!",{position:"top-right",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored",transition:s.br}),a())},[Z]);let af=async a=>{let b=a.selectedLabOrderIds||[],c=Object.entries(ag.filter(a=>b.includes(a.id)).map(a=>({testName:a.test,testId:a.id,specimenType:a.specimen,date:a.date,...a?.comment_to_fulfiller?{comment_to_fulfiller:a.comment_to_fulfiller}:{}})).reduce((a,b)=>{let c=`${b.specimenType}|${b.date}`;return a[c]||(a[c]=[]),a[c].push(b),a},{})).map(async([a,b])=>{let[c,d]=a.split("|"),e=await Promise.all(b.map(async a=>({concept:await (0,q.cr)(a.testName).then(a=>a.data[0].uuid)}))),f=await (0,q.cr)(c).then(a=>a.data[0].uuid);return{patient:W,visit:V,tests:e,reason_for_test:"b998cdac-8d80-11d8-abbb-0024217bb78e",target_lab:"Blantyre Dream Project Clinic",date:d,requesting_clinician:localStorage.getItem("userName"),comment_to_fulfiller:b[0].comment_to_fulfiller||"",specimen:{concept:f,specimenType:c}}});X({orders:await Promise.all(c)}),aa(),ac()},ag=[];_&&_?.length>0&&(ag=_[0]?.obs?.flatMap(a=>a.children.map(b=>{let c;return b.children&&b.children.length>0&&(c=b.children.find(a=>a.names.find(a=>a.name==p.W.DESCRIPTION))),{test:b.names[0].name,testConceptId:b.concept_id,date:a.obs_datetime,specimen:a.names[0].name,id:b.obs_id,...c?{comment_to_fulfiller:c?.value}:{}}})),ab&&ab?.length>0&&(ag=((a,b)=>{let c=new Map;return b.forEach(a=>{a.obs.forEach(a=>{if(null!==a.value_coded){let b=`${a.value_coded}_${a.obs_datetime}`;c.set(b,!0)}})}),a.filter(a=>{let b=`${a.testConceptId}_${a.date}`;return!c.has(b)})})(ag,ab)));let ah=ag.reduce((a,b)=>{let c=b.specimen;return a[c]||(a[c]=[]),a[c].push(b),a},{});return(0,d.jsx)(t.h,{loading:Y,children:(0,d.jsx)(f.PD,{initialValues:{testType:"",sampleType:"",selectedLabOrderIds:[]},onSubmit:af,validationSchema:j.Ik().shape({selectedLabOrderIds:j.YO().of(j.ai())}),children:ag.length>0&&(0,d.jsx)(v,{groupedTests:ah})})})}},71819:(a,b,c)=>{c.d(b,{c:()=>f});var d=c(21124);c(38301);var e=c(80350);let f=({diagnoses:a})=>{let b=[{field:"condition",headerName:"Diagnosis",flex:1},{field:"label",headerName:"Diagnosis Type ",flex:1,renderCell:()=>(0,d.jsx)("span",{children:"Differential Diagnosis"})},{field:"obsDatetime",headerName:"Date Recorded",flex:1,renderCell:a=>{let b=a.row.obsDatetime;return(0,d.jsx)("span",{children:b?new Date(b).toLocaleDateString():"N/A"})}}];return(0,d.jsx)(e.WE,{rows:a,columns:b,height:"400px",width:"100%",showTopBar:!1})}},80345:(a,b,c)=>{c.d(b,{J:()=>w});var d=c(21124),e=c(80350),f=c(24390),g=c(95745),h=c(90675),i=c(82283),j=c(50852),k=c(16776),l=c(38301),m=c(12781),n=c(48936);let o=()=>[{value:g.W.POSITIVE,label:"Positive"},{value:g.W.NEGATIVE,label:"Negative"},{value:g.W.INDETERMINATE,label:"Indeterminate"}],p=(a,b)=>b.includes("HIV")||b.includes("Test")||b.includes("MRDT")||a.includes("Pregnancy test")||a.includes("vdrl")||a.includes("pocus")||a.includes("ecg")?"radio":a.includes("pH")||a.includes("PCO2")||a.includes("PO2")||a.includes("CK")||a.includes("CNA")||a.includes("glucose")||a.includes("BASE_EXCESS")||a.includes("LACTATE")?"number":"text";var q=c(81637),r=c(79515);let s=({formStructure:a})=>{let b=o(),c=a=>{if(!a)return null;switch(a.type){case"section":return(0,d.jsxs)(q.default,{sx:{mb:4},children:[(0,d.jsx)(r.default,{variant:"h6",color:"GrayText",sx:{mb:2},children:a.title}),a.items.length>0&&(0,d.jsx)(e.m2,{children:a.items.map(a=>c(a))})]},a.title);case"text":return(0,d.jsx)(e.A8,{id:a.name,name:a.name,label:a.label,multiline:a.multiline,rows:a.multiline?4:1},a.name);case"number":return(0,d.jsx)(e.A8,{id:a.name,name:a.name,label:a.label,type:"number"},a.name);case"radio":return(0,d.jsx)(e.b1,{name:a.name,label:a.label,options:a.options||b},a.name);default:return null}};return(0,d.jsx)(d.Fragment,{children:a.map(a=>c(a))})},t=(a,b)=>{let c=b.flatMap(a=>a.items?a.items:[a]).find(b=>b.name===a);return c&&void 0!==c.obs_id?c.obs_id:null},u=(a,b,c=new Date().toISOString())=>{let d={};for(let e in a){let[f,...h]=e.split("_"),i=h.join("_");d[f]||(d[f]=[]),d[f].push({concept:i||e,obsDatetime:c,value:a[e],groupMembers:[{concept:g.W.DESCRIPTION,obsDatetime:c,value:t(e,b)}]})}let e=[];for(let a in d)e.push({concept:g.W.DESCRIPTION||"DESCRIPTION",obsDatetime:c,value:a,groupMembers:d[a]});return e};var v=c(68730);let w=({onClose:a})=>{let{activeVisit:b,patientId:c}=(0,i.gd)(),{ServerTime:q}=(0,h.useServerTime)(),{mutate:r,isPending:t,isSuccess:w}=(0,j.jM)(),{data:x,isLoading:y}=(0,j.$O)(c,`encounter_type=${g.fA.BED_SIDE_TEST}`),{data:z,refetch:A,isLoading:B}=(0,j.$O)(c,`encounter_type=${g.fA.BEDSIDE_INVESTIGATION_PLAN}`),{formStructure:C,initialValues:D,validationSchema:E}=((a,b,c)=>{let[d,e]=(0,l.useState)([]),[f,g]=(0,l.useState)({}),[h,i]=(0,l.useState)(n.Ik()),j=(0,l.useCallback)(a=>{let b=[];if(!a||!Array.isArray(a))return b;for(let c of a){(c.value||c.value_text)&&b.push(c.value||c.value_text);let a=j(c.children);b.push(...a)}return b},[]),k=(0,l.useCallback)(a=>{let b=new Set;if(!a||!Array.isArray(a))return b;for(let c of a)j(c.children).forEach(a=>{let c=parseInt(a);isNaN(c)||b.add(c)});return b},[j]),m=(0,l.useCallback)((a,b)=>{if(!a||!Array.isArray(a))return[];let c=[];for(let d of a)if(!b.has(d.obs_id))if(d.children&&Array.isArray(d.children)){let a=m(d.children,b);c.push({...d,children:a})}else c.push(d);return c},[]),q=(0,l.useCallback)((a,b)=>{if(!a||!Array.isArray(a))return[];if(!b||!Array.isArray(b))return a;let c=k(b),d=[];for(let b of a)if(!c.has(b.obs_id))if(b.children&&Array.isArray(b.children)){let a=m(b.children,c);if(0===a.length&&b.children.length>0)continue;d.push({...b,children:a})}else d.push(b);return d},[k,m]);return(0,l.useEffect)(()=>{},[b,c]),(0,l.useEffect)(()=>{if(a&&a?.length>0){let d=[],f={},h={},j={"Arterial Blood Gas_pH":n.ai().min(7.35).max(7.45).label("pH"),"Arterial Blood Gas_PCO2":n.ai().min(35).max(45).label("PCO2"),"Arterial Blood Gas_PO2":n.ai().min(75).max(100).label("PO2"),"Arterial Blood Gas_Base Excess":n.ai().min(-4).max(2).label("Base Excess"),"Arterial Blood Gas_LACTATE":n.ai().min(0).max(2).label("Lactate"),"Arterial Blood Gas_SO2E":n.ai().min(95).max(100).label("SO2E"),"Arterial Blood Gas_P50E":n.ai().min(24).max(28).label("P50E"),"Arterial Blood Gas_HCO3":n.ai().min(3).max(7).label("HCO3"),"Electrolyte Values_CK":n.ai().min(3.5).max(5.5).label("CK"),"Electrolyte Values_CNA":n.ai().min(135).max(145).label("CNA"),"Electrolyte Values_CA2":n.ai().label("CA2"),"Electrolyte Values_CCL":n.ai().label("CCL"),"Electrolyte Values_glucose":n.ai().min(3).max(7).label("Glucose"),"Electrolyte Values_ANION_GAPC":n.ai().label("Anion Gap"),"Electrolyte Values_MOSMC":n.ai().label("MOSMC"),"Electrolyte Values_FO2HBE":n.ai().label("FO2HBE"),"Electrolyte Values_FHHBE":n.ai().label("FHHBE"),Dipstick_urobilinogen:n.Yj().label("Urobilinogen"),Dipstick_leukocytes:n.Yj().label("Leukocytes"),Dipstick_bilirubin:n.Yj().label("Bilirubin"),Dipstick_glucose:n.Yj().label("Glucose"),"Dipstick_Specific Gravity":n.Yj().label("Specific Gravity"),Dipstick_protein:n.Yj().label("Protein"),Dipstick_nitrite:n.Yj().label("Nitrite"),Dipstick_ketones:n.Yj().label("Ketones"),Dipstick_blood:n.Yj().label("Blood"),mrdt:n.Yj().required().label("MRDT"),pregnancyTest:n.Yj().label("Pregnancy test"),hiv:n.Yj().label("HIV"),vdrl:n.Yj().label("VDRL"),pocus:n.Yj().label("POCUS"),ecg:n.Yj().label("ECG"),other:n.Yj().label("Other")},k=a[0]?.obs.reduce((a,b)=>new Date(b.obs_datetime)>new Date(a)?b.obs_datetime:a,a[0]?.obs[0]?.obs_datetime),l=a[0]?.obs.filter(a=>a.obs_datetime===k),m=l;!c&&b&&Array.isArray(b)&&b.length>0&&(console.log("\uD83D\uDE80 ~ useEffect ~ BedSideResults:",b),m=q(l,b[0].obs)),m&&Array.isArray(m)&&m.forEach(a=>{let b=((a,b,c,d)=>{if(!a)return null;let e=o();if(!a.children||0===a.children.length){let f=a.names&&a.names[0]?a.names[a.names.length-1].name:`Field ${a.concept_id}`,g=`${f}`;b[g]=a.value||"";let h=g.toLowerCase().replace(/\s+/g,"");c[g]=d[g]||d[h]||n.Yj();let i=p(g,f);return"radio"===i?{type:"radio",name:g,label:f,obs_id:a.obs_id,options:e}:{type:i,name:g,label:f,obs_id:a.obs_id,multiline:f.includes("Notes")||f.includes("Description")}}let f=[];return a.children.forEach(e=>{let g=e.names&&e.names[0]?e.names[0].name:`Field ${e.concept_id}`,h=`${a.value}_${g}`;b[h]=e.value||"",c[h]=d[h]||n.Yj();let i=p(h,g);f.push({type:i,name:h,label:g,obs_id:e.obs_id})}),{type:"section",title:a.value,items:f}})(a,f,h,j);b&&d.push(b)}),e(d),g(f);try{if(Object.keys(h).length>0){let a=n.Ik().shape(h);i(a)}else i(n.Ik())}catch(a){i(n.Ik())}}},[a,b,c,q]),(0,l.useEffect)(()=>{},[h,f]),{formStructure:d,initialValues:f,validationSchema:h}})(z,x,y);return(0,l.useEffect)(()=>{A()}),(0,l.useEffect)(()=>{w&&m.oR.success("Bedside test submitted successfully!",{position:"top-right",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"colored",transition:m.br})},[w]),(0,d.jsx)(f.h,{loading:t||y||B,children:(0,d.jsx)(e.PD,{validationSchema:E,onSubmit:a=>{let d=q.getServerTimeString(),e=u(a,C,d);e.length>0&&r({encounterType:g.fA.BED_SIDE_TEST,visit:b,patient:c,encounterDatetime:d,obs:e})},initialValues:{...D},submitButton:!1,children:({values:a,submitCount:e})=>(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(k.lV,{children:(0,d.jsx)(s,{formStructure:C})}),e>0?(0,d.jsx)(v.A,{variant:"contained",onClick:()=>(a=>{let d=q.getServerTimeString(),e=u(a,C,d);e.length>0&&r({encounterType:g.fA.BED_SIDE_TEST,visit:b,patient:c,encounterDatetime:d,obs:e})})(a),children:"submit anyway"}):(0,d.jsx)(v.A,{variant:"contained",type:"submit",children:"submit"})]})})})}},82973:(a,b,c)=>{c.d(b,{A:()=>q});var d=c(21124),e=c(80350),f=c(38301),g=c(71819),h=c(79515),i=c(68730),j=c(50852),k=c(12781),l=c(82283),m=c(66951),n=c(95745),o=c(90675),p=c(12919);let q=function({conceptType:a}){let[b,c]=(0,f.useState)([]),{mutate:q,isSuccess:r,isError:s}=(0,j.jM)(),{params:t}=(0,l.KU)(),{data:u}=(0,m.GN)(t.id),[v,w]=(0,f.useState)(void 0),[x,y]=(0,f.useState)(!1),[z,A]=(0,f.useState)({}),[B,C]=(0,f.useState)(!1),{data:D}=(0,m.iu)(t.id),{data:E,refetch:F}=(0,j.$O)(t.id,`encounter_type=${n.fA.OUTPATIENT_DIAGNOSIS}`),{mutate:G}=(0,j.tI)(),{init:H,ServerTime:I}=(0,o.useServerTime)();return(0,d.jsxs)(e.Yr,{container:!0,spacing:2,children:[(0,d.jsx)(e.Yr,{item:!0,xs:12,children:(0,d.jsxs)(e.sc,{style:{padding:"20px"},children:[(0,d.jsx)(h.default,{variant:"subtitle1",style:{marginBottom:"10px",fontWeight:"500"},children:"Current Diagnosis"}),(0,d.jsx)("br",{}),(0,d.jsxs)("div",{style:{display:"flex",paddingBottom:"8px",borderBottom:"1px solid #ddd"},children:[(0,d.jsx)(h.default,{variant:"body2",style:{width:"40%",fontWeight:"500"},children:"Condition"}),(0,d.jsx)(h.default,{variant:"body2",style:{width:"25%",fontWeight:"500"},children:"Diagnosis Type"}),(0,d.jsx)(h.default,{variant:"body2",style:{width:"25%",fontWeight:"500"},children:"Date"}),(0,d.jsx)(h.default,{variant:"body2",style:{width:"10%",fontWeight:"500"},children:"Action"})]}),0===b.length?(0,d.jsx)(h.default,{variant:"body2",style:{padding:"16px",textAlign:"center",color:"gray"},children:"No Diagnosis Added"}):b.slice(-3).map(b=>(0,d.jsxs)("div",{style:{display:"flex",alignItems:"center",borderBottom:"1px solid #f0f0f0"},children:[(0,d.jsx)(h.default,{variant:"body2",style:{width:"40%"},children:b.condition}),(0,d.jsx)(h.default,{variant:"body2",style:{width:"25%",fontStyle:"italic"},children:a===n.W.DIFFERENTIAL_DIAGNOSIS?"Differential Diagnosis":"Final Diagnosis"}),(0,d.jsx)(h.default,{variant:"body2",style:{width:"25%"},children:new Date(b.obsDatetime).toLocaleDateString("en-GB")}),(0,d.jsx)(h.default,{variant:"body2",style:{width:"10%"},children:(0,d.jsx)(i.A,{onClick:()=>{var a;G(a=b.id,{onSuccess:()=>{c(b=>b.filter(b=>b.id!==a))},onError:()=>{console.error("Error deleting diagnosis")}})},size:"small",color:"error",variant:"text",children:"Delete"})})]},b.id)),(0,d.jsx)(h.default,{variant:"subtitle2",style:{color:"green",cursor:"pointer",marginTop:"30px"},onClick:()=>C(!B),children:B?"- Cancel New Diagnosis":"+ Add New Diagnosis"}),B&&(0,d.jsx)(p.default,{label:"Select Diagnosis",initialValue:"",onSelection:b=>{let c=I.getServerTimeString();b&&v?.uuid?q({encounterType:n.fA.OUTPATIENT_DIAGNOSIS,visit:v?.uuid,patient:t.id,encounterDatetime:c,obs:[{concept:a,value:`${b.code} - ${b.diagnosis}`,obsDatetime:c}]},{onSuccess:async()=>{await F()},onError:()=>{k.oR.error("Failed to submit diagnosis.")}}):k.oR.error("Visit information is missing, cannot add diagnosis.")},placeholder:"Start typing to search diagnoses..."})]})}),(0,d.jsx)(e.Yr,{item:!0,xs:12,children:(0,d.jsxs)(e.sc,{children:[(0,d.jsx)(h.default,{onClick:()=>y(!x),variant:"subtitle1",style:{cursor:"pointer",padding:"1ch",fontWeight:"500"},children:x?"Hide Previous Diagnosis":"Show Previous Diagnosis"}),x&&(0,d.jsx)(g.c,{diagnoses:b})]})})]})}}};